- hosts: debian-node
  become: true
  vars:
    user: vagrant
    env: dev
    file_data:
      - domain: "@produzione"
      - domain: "@collaudo"
      - domain: "@sviluppo"

  tasks:
    - name: Aggiorna apt cache e installa Jinja2 runtime (python3-jinja2)
      apt:
        name: python3-jinja2
        state: present
        update_cache: yes

    - name: Crea il file renderizzato da Jinja sulla macchina remota
      template:
        src: templates/jinja-conf.j2
        dest: /tmp/output.txt
        mode: '0644'

    - name: Verifica se il file /tmp/output.txt esiste
      stat:
        path: /tmp/output.txt
      register: output_stat

    - name: Fallisci se il file /tmp/output.txt non è stato creato
      fail:
        msg: "Il file /tmp/output.txt non è stato creato dal template!"
      when: not output_stat.stat.exists

    - name: Leggi il file output.txt generato sulla macchina remota
      slurp:
        src: /tmp/output.txt
      register: output_file

    - name: Aggiungi il blocco generato al file limits.conf
      blockinfile:
        path: /etc/security/limits.conf
        block: "{{ output_file.content | b64decode }}"
        insertafter: EOF
        create: yes
